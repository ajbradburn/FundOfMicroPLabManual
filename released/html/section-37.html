<!DOCTYPE html>
<!--********************************************-->
<!--*       Generated from PreTeXt source      *-->
<!--*       on 2022-04-12T09:19:03-04:00       *-->
<!--*   A recent stable commit (2020-08-09):   *-->
<!--* 98f21740783f166a773df4dc83cab5293ab63a4a *-->
<!--*                                          *-->
<!--*         https://pretextbook.org          *-->
<!--*                                          *-->
<!--********************************************-->
<html lang="en-US">
<head xmlns:og="http://ogp.me/ns#" xmlns:book="https://ogp.me/ns/book#">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Connecting Using Data Exchange Protocols</title>
<meta name="Keywords" content="Authored in PreTeXt">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta property="og:type" content="book">
<meta property="book:title" content="An Introduction to Embedded Systems and Applications">
<meta property="book:author" content="Anthony Bradburn">
<script>window.MathJax = {
  tex: {
    inlineMath: [['\\(','\\)']],
    tags: "none",
    useLabelIds: true,
    tagSide: "right",
    tagIndent: ".8em",
    packages: {'[+]': ['base', 'extpfeil', 'ams', 'amscd', 'newcommand', 'knowl']}
  },
  options: {
    ignoreHtmlClass: "tex2jax_ignore|ignore-math",
    processHtmlClass: "process-math",
  },
  chtml: {
    scale: 0.88,
    mtextInheritFont: true
  },
  loader: {
    load: ['input/asciimath', '[tex]/extpfeil', '[tex]/amscd', '[tex]/newcommand', '[pretext]/mathjaxknowl3.js'],
    paths: {pretext: "https://pretextbook.org/js/lib"},
  },
};
</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script><link href="https://unpkg.com/prismjs@v1.22.0/themes/prism.css" rel="stylesheet">
<script src="https://pretextbook.org/js/lib/jquery.min.js"></script><script src="https://pretextbook.org/js/lib/jquery.sticky.js"></script><script src="https://pretextbook.org/js/lib/jquery.espy.min.js"></script><script src="https://pretextbook.org/js/0.13/pretext.js"></script><script>miniversion=0.674</script><script src="https://pretextbook.org/js/0.13/pretext_add_on.js?x=1"></script><script src="https://pretextbook.org/js/lib/knowl.js"></script><!--knowl.js code controls Sage Cells within knowls--><script>sagecellEvalName='Evaluate (Sage)';
</script><link href="https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,600,600italic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700&amp;subset=latin,latin-ext" rel="stylesheet" type="text/css">
<link href="https://pretextbook.org/css/0.4/pretext.css" rel="stylesheet" type="text/css">
<link href="https://pretextbook.org/css/0.4/pretext_add_on.css" rel="stylesheet" type="text/css">
<link href="https://pretextbook.org/css/0.4/banner_default.css" rel="stylesheet" type="text/css">
<link href="https://pretextbook.org/css/0.4/toc_default.css" rel="stylesheet" type="text/css">
<link href="https://pretextbook.org/css/0.4/knowls_default.css" rel="stylesheet" type="text/css">
<link href="https://pretextbook.org/css/0.4/style_default.css" rel="stylesheet" type="text/css">
<link href="https://pretextbook.org/css/0.4/colors_blue_red.css" rel="stylesheet" type="text/css">
<link href="https://pretextbook.org/css/0.4/setcolors.css" rel="stylesheet" type="text/css">
<!-- 2019-10-12: Temporary - CSS file for experiments with styling --><link href="developer.css" rel="stylesheet" type="text/css">
</head>
<body class="pretext-book ignore-math has-toc has-sidebar-left">
<a class="assistive" href="#content">Skip to main content</a><div id="latex-macros" class="hidden-content process-math" style="display:none"><span class="process-math">\(\newcommand{\N}{\mathbb N}
\newcommand{\Z}{\mathbb Z}
\newcommand{\Q}{\mathbb Q}
\newcommand{\R}{\mathbb R}
\newcommand{\lt}{&lt;}
\newcommand{\gt}{&gt;}
\newcommand{\amp}{&amp;}
\)</span></div>
<header id="masthead" class="smallbuttons"><div class="banner"><div class="container">
<a id="logo-link" href=""></a><div class="title-container">
<h1 class="heading"><a href="my-great-book.html"><span class="title">An Introduction to Embedded Systems and Applications:</span> <span class="subtitle">Through the Raspberry Pi</span></a></h1>
<p class="byline">Anthony Bradburn</p>
</div>
</div></div>
<nav id="primary-navbar" class="navbar"><div class="container">
<div class="navbar-top-buttons">
<button class="sidebar-left-toggle-button button active" aria-label="Show or hide table of contents sidebar">Contents</button><div class="tree-nav toolbar toolbar-divisor-3"><span class="threebuttons"><a id="previousbutton" class="previous-button toolbar-item button" href="section-36.html" title="Previous">Prev</a><a id="upbutton" class="up-button button toolbar-item" href="ch-first.html" title="Up">Up</a><a id="nextbutton" class="next-button button toolbar-item" href="section-38.html" title="Next">Next</a></span></div>
</div>
<div class="navbar-bottom-buttons toolbar toolbar-divisor-4">
<button class="sidebar-left-toggle-button button toolbar-item active">Contents</button><a class="previous-button toolbar-item button" href="section-36.html" title="Previous">Prev</a><a class="up-button button toolbar-item" href="ch-first.html" title="Up">Up</a><a class="next-button button toolbar-item" href="section-38.html" title="Next">Next</a>
</div>
</div></nav></header><div class="page">
<div id="sidebar-left" class="sidebar" role="navigation"><div class="sidebar-content">
<nav id="toc"><ul>
<li class="link frontmatter">
<a href="frontmatter.html" data-scroll="frontmatter" class="internal"><span class="title">Front Matter</span></a><ul>
<li><a href="colophon-1.html" data-scroll="colophon-1" class="internal">Colophon</a></li>
<li><a href="preface.html" data-scroll="preface" class="internal">Feedback about the text</a></li>
</ul>
</li>
<li class="link">
<a href="ch-first.html" data-scroll="ch-first" class="internal"><span class="codenumber">1</span> <span class="title">Setting up for, and exploring assembly programming.</span></a><ul>
<li><a href="section-1.html" data-scroll="section-1" class="internal">Installing Code::Blocks IDE in Raspberry Pi OS</a></li>
<li><a href="section-2.html" data-scroll="section-2" class="internal">Writing and Debugging Programs</a></li>
</ul>
</li>
<li class="link">
<a href="ch-first.html" data-scroll="ch-first" class="internal"><span class="codenumber">2</span> <span class="title">Basics of Programming</span></a><ul>
<li><a href="section-3.html" data-scroll="section-3" class="internal">Where to begin?</a></li>
<li><a href="section-4.html" data-scroll="section-4" class="internal">Defining the problem.</a></li>
<li><a href="section-5.html" data-scroll="section-5" class="internal">Framing the Solution.</a></li>
<li><a href="section-6.html" data-scroll="section-6" class="internal">Documenting the process.</a></li>
<li><a href="section-7.html" data-scroll="section-7" class="internal">Writing Code</a></li>
</ul>
</li>
<li class="link">
<a href="ch-first.html" data-scroll="ch-first" class="internal"><span class="codenumber">3</span> <span class="title">Basics of Assembly</span></a><ul>
<li><a href="section-8.html" data-scroll="section-8" class="internal">Associated Reading</a></li>
<li><a href="section-9.html" data-scroll="section-9" class="internal">Basic Operations and Composition</a></li>
<li><a href="section-10.html" data-scroll="section-10" class="internal">Memory Addressing</a></li>
<li><a href="section-11.html" data-scroll="section-11" class="internal">Arithmetic Functions</a></li>
<li><a href="section-12.html" data-scroll="section-12" class="internal">Logical Operations</a></li>
<li><a href="section-13.html" data-scroll="section-13" class="internal">C</a></li>
</ul>
</li>
<li class="link">
<a href="ch-first.html" data-scroll="ch-first" class="internal"><span class="codenumber">4</span> <span class="title">Assembly Control Structures</span></a><ul>
<li><a href="section-14.html" data-scroll="section-14" class="internal">Associated Reading</a></li>
<li><a href="section-15.html" data-scroll="section-15" class="internal">Loops</a></li>
<li><a href="section-16.html" data-scroll="section-16" class="internal">Branching</a></li>
</ul>
</li>
<li class="link">
<a href="ch-first.html" data-scroll="ch-first" class="internal"><span class="codenumber">5</span> <span class="title">High-level Programming Languages</span></a><ul>
<li><a href="section-17.html" data-scroll="section-17" class="internal">Associated Reading</a></li>
<li><a href="section-18.html" data-scroll="section-18" class="internal">High Level Programming Languages</a></li>
<li><a href="section-19.html" data-scroll="section-19" class="internal">Libraries</a></li>
<li><a href="section-20.html" data-scroll="section-20" class="internal">Functions</a></li>
<li><a href="section-21.html" data-scroll="section-21" class="internal">Variables</a></li>
<li><a href="section-22.html" data-scroll="section-22" class="internal">Control Structures</a></li>
<li><a href="section-23.html" data-scroll="section-23" class="internal">Structure</a></li>
</ul>
</li>
<li class="link">
<a href="ch-first.html" data-scroll="ch-first" class="internal"><span class="codenumber">6</span> <span class="title">Setting up for, and exploring python programming.</span></a><ul>
<li><a href="section-24.html" data-scroll="section-24" class="internal">Raspi Config</a></li>
<li><a href="section-25.html" data-scroll="section-25" class="internal">Installing Python Libraries</a></li>
<li><a href="section-26.html" data-scroll="section-26" class="internal">The Thonny Python IDE</a></li>
<li><a href="section-27.html" data-scroll="section-27" class="internal">Debugging with Python</a></li>
</ul>
</li>
<li class="link">
<a href="ch-first.html" data-scroll="ch-first" class="internal"><span class="codenumber">7</span> <span class="title">Python Basics</span></a><ul>
<li><a href="section-28.html" data-scroll="section-28" class="internal">Associated Reading</a></li>
<li><a href="section-29.html" data-scroll="section-29" class="internal">Basic Python Programs</a></li>
<li><a href="section-30.html" data-scroll="section-30" class="internal">Data Types</a></li>
<li><a href="section-31.html" data-scroll="section-31" class="internal">Checking User Input</a></li>
<li><a href="section-32.html" data-scroll="section-32" class="internal">Providing Output</a></li>
</ul>
</li>
<li class="link">
<a href="ch-first.html" data-scroll="ch-first" class="internal"><span class="codenumber">8</span> <span class="title">Interfacing Basics</span></a><ul>
<li><a href="section-33.html" data-scroll="section-33" class="internal">Associated Reading</a></li>
<li><a href="section-34.html" data-scroll="section-34" class="internal">Connecting the Pi to Peripherials</a></li>
<li><a href="section-35.html" data-scroll="section-35" class="internal">Troubleshooting</a></li>
</ul>
</li>
<li class="link">
<a href="ch-first.html" data-scroll="ch-first" class="internal"><span class="codenumber">9</span> <span class="title">Interfacing with increased versatility, and complexity.</span></a><ul>
<li><a href="section-36.html" data-scroll="section-36" class="internal">Associated Reading</a></li>
<li><a href="section-37.html" data-scroll="section-37" class="active">Connecting Using Data Exchange Protocols</a></li>
<li><a href="section-38.html" data-scroll="section-38" class="internal">Reading and Using Data</a></li>
</ul>
</li>
<li class="link">
<a href="ch-first.html" data-scroll="ch-first" class="internal"><span class="codenumber">10</span> <span class="title">Data Management</span></a><ul>
<li><a href="section-39.html" data-scroll="section-39" class="internal">Associated Reading</a></li>
<li><a href="section-40.html" data-scroll="section-40" class="internal">Connecting to the Internet</a></li>
</ul>
</li>
<li class="link backmatter"><a href="backmatter.html" data-scroll="backmatter" class="internal"><span class="title">Backmatter</span></a></li>
<li class="link">
<a href="appendix-1.html" data-scroll="appendix-1" class="internal"><span class="codenumber">A</span> <span class="title">References</span></a><ul><li><a href="references-section.html" data-scroll="references-section" class="internal">References</a></li></ul>
</li>
<li class="link">
<a href="appendix-2.html" data-scroll="appendix-2" class="internal"><span class="codenumber">B</span> <span class="title">Sourcing Suggestions</span></a><ul>
<li><a href="section-41.html" data-scroll="section-41" class="internal">Raspberry Pi</a></li>
<li><a href="section-42.html" data-scroll="section-42" class="internal">Sensors and Misc Components</a></li>
</ul>
</li>
<li class="link">
<a href="appendix-3.html" data-scroll="appendix-3" class="internal"><span class="codenumber">C</span> <span class="title">Using Pretext</span></a><ul>
<li><a href="section-43.html" data-scroll="section-43" class="internal">Editing and Building Custom Versions</a></li>
<li><a href="section-44.html" data-scroll="section-44" class="internal">Using PreTeXt CLI</a></li>
</ul>
</li>
<li class="link"><a href="colophon-2.html" data-scroll="colophon-2" class="internal"><span class="title">Colophon</span></a></li>
</ul></nav><div class="extras"><nav><a class="pretext-link" href="https://pretextbook.org">Authored in PreTeXt</a><a href="https://www.mathjax.org"><img title="Powered by MathJax" src="https://www.mathjax.org/badge/badge.gif" alt="Powered by MathJax"></a></nav></div>
</div></div>
<main class="main"><div id="content" class="pretext-content">
<section class="section" id="section-37"><h2 class="heading hide-type">
<span class="type">Section</span> <span class="codenumber">9.2</span> <span class="title">Connecting Using Data Exchange Protocols</span>
</h2>
<section class="subsection" id="subsection-86"><h3 class="heading hide-type">
<span class="type">Subsection</span> <span class="codenumber">9.2.1</span> <span class="title">Discussion</span>
</h3>
<p id="p-293">This lab builds upon the last by adding some components and making changes to the code.</p>
<p id="p-294">When it comes to interfacing with external micro-controllers it is necessary to communicate with very specific sequences 1s and 0s. The methods for accomplishing this are defined by the communication protocol, and the micro controller itself. This data can be found in the data sheet for said micro controller.</p>
<p id="p-295">It may eventually be necessary for you to write your own code for interfacing with such a device, but right now we are going to gloss over the tedious details of doing so, and rely upon the work of other skilled people. We will import libraries for an OLED display as well as an AHT20 Temperature and Humidity sensor. These libraries take care of sending and receiving the bytes of data that are necessary to make these useful to us. We are going to focus on the process of wiring up these new sensors on the <span class="process-math">\(I^2C\)</span> bus, and making use of them for our own purposes.</p></section><section class="subsection" id="subsection-87"><h3 class="heading hide-type">
<span class="type">Subsection</span> <span class="codenumber">9.2.2</span> <span class="title">Required Equipment</span>
</h3>
<p id="p-296">These are the required components.</p>
<figure class="table table-like" id="table-4"><figcaption><span class="type">Table</span><span class="space"> </span><span class="codenumber">9.2.1<span class="period">.</span></span><span class="space"> </span></figcaption><div class="tabular-box natural-width"><table class="tabular">
<tr>
<td class="l m b0 r0 l0 t0 lines">Amount</td>
<td class="l m b0 r0 l0 t0 lines">Part Type</td>
</tr>
<tr>
<td class="l m b0 r0 l0 t0 lines">1</td>
<td class="l m b0 r0 l0 t0 lines">Breadboard</td>
</tr>
<tr>
<td class="l m b0 r0 l0 t0 lines">1</td>
<td class="l m b0 r0 l0 t0 lines">128x32 I2C Monochrome OLED Display</td>
</tr>
<tr>
<td class="l m b0 r0 l0 t0 lines">1</td>
<td class="l m b0 r0 l0 t0 lines">AHT20 Temperature and Humidity Sensor</td>
</tr>
<tr>
<td class="l m b0 r0 l0 t0 lines">1</td>
<td class="l m b0 r0 l0 t0 lines">100nF Capacitor</td>
</tr>
<tr>
<td class="l m b0 r0 l0 t0 lines">6</td>
<td class="l m b0 r0 l0 t0 lines">Red LED</td>
</tr>
<tr>
<td class="l m b0 r0 l0 t0 lines">6</td>
<td class="l m b0 r0 l0 t0 lines">470Ω Resistor</td>
</tr>
<tr>
<td class="l m b0 r0 l0 t0 lines">1</td>
<td class="l m b0 r0 l0 t0 lines">10KΩ Resistor</td>
</tr>
<tr>
<td class="l m b0 r0 l0 t0 lines">1</td>
<td class="l m b0 r0 l0 t0 lines">Raspberry Pi 3</td>
</tr>
<tr>
<td class="l m b0 r0 l0 t0 lines">1</td>
<td class="l m b0 r0 l0 t0 lines">Push button</td>
</tr>
<tr>
<td class="l m b0 r0 l0 t0 lines">Handful</td>
<td class="l m b0 r0 l0 t0 lines">Male to Female Jumper Wires</td>
</tr>
<tr>
<td class="l m b0 r0 l0 t0 lines">Handful</td>
<td class="l m b0 r0 l0 t0 lines">Solid Core Jumper Wires</td>
</tr>
</table></div></figure></section><section class="subsection" id="subsection-88"><h3 class="heading hide-type">
<span class="type">Subsection</span> <span class="codenumber">9.2.3</span> <span class="title">Preview</span>
</h3>
<p id="p-297">We have two objectives. The first is to make use of the OLED display to display the roll results for our dice program. The second is to read the temperature and humidity from our AHT20 sensor, and then display that data on the OLED display.</p>
<p id="p-298">This is what we are aiming for:</p>
<figure class="figure figure-like" id="figure-47"><div class="image-box" style="width: 100%; margin-left: 0%; margin-right: 0%;"><img src="external/photographs/interfacing_bus_protocols_bb.jpg" class="contained" alt="A Raspberry Pi 3 with GPIO pins connected to an array of LEDs and a momentary switch."></div>
<figcaption><span class="type">Figure</span><span class="space"> </span><span class="codenumber">9.2.2<span class="period">.</span></span><span class="space"> </span>The Completed Circuit</figcaption></figure><figure class="figure figure-like" id="figure-48"><div class="image-box" style="width: 100%; margin-left: 0%; margin-right: 0%;"><img src="external/generated/interfacing_bus_protocols_bb.svg" role="img" class="contained" alt="A Raspberry Pi 3 with GPIO pins connected to an array of LEDs and a momentary switch."></div>
<figcaption><span class="type">Figure</span><span class="space"> </span><span class="codenumber">9.2.3<span class="period">.</span></span><span class="space"> </span>The Completed Circuit</figcaption></figure></section><section class="subsection" id="subsection-89"><h3 class="heading hide-type">
<span class="type">Subsection</span> <span class="codenumber">9.2.4</span> <span class="title">Wiring</span>
</h3>
<p id="p-299">In order to match the code that will follow, special care will be needed with matching the correct GPIO to the proper components.</p>
<figure class="figure figure-like" id="figure-49"><div class="image-box" style="width: 100%; margin-left: 0%; margin-right: 0%;"><img src="external/images/gpiopinsv3withpi.svg" role="img" class="contained" alt="The GPIO pinout for the Raspberry Pi 3."></div>
<figcaption><span class="type">Figure</span><span class="space"> </span><span class="codenumber">9.2.4<span class="period">.</span></span><span class="space"> </span>Raspberry Pi 3 GPIO Pinout</figcaption></figure><figure class="table table-like" id="table-5"><figcaption><span class="type">Table</span><span class="space"> </span><span class="codenumber">9.2.5<span class="period">.</span></span><span class="space"> </span></figcaption><div class="tabular-box natural-width"><table class="tabular">
<tr>
<td class="l m b0 r0 l0 t0 lines">GPIO Designation</td>
<td class="l m b0 r0 l0 t0 lines">Header Pin</td>
<td class="l m b0 r0 l0 t0 lines">Component</td>
</tr>
<tr>
<td class="l m b0 r0 l0 t0 lines">GPIO2/SDA1</td>
<td class="l m b0 r0 l0 t0 lines">Pin 3</td>
<td class="l m b0 r0 l0 t0 lines">SDA (OLED/AHT20)</td>
</tr>
<tr>
<td class="l m b0 r0 l0 t0 lines">GPIO3/SCL1</td>
<td class="l m b0 r0 l0 t0 lines">Pin 5</td>
<td class="l m b0 r0 l0 t0 lines">SCL (OLED/AHT20)</td>
</tr>
<tr>
<td class="l m b0 r0 l0 t0 lines">3.3V</td>
<td class="l m b0 r0 l0 t0 lines">1</td>
<td class="l m b0 r0 l0 t0 lines">VCC/VIN (OLED/AHT20)</td>
</tr>
<tr>
<td class="l m b0 r0 l0 t0 lines">GND</td>
<td class="l m b0 r0 l0 t0 lines">Pin 9</td>
<td class="l m b0 r0 l0 t0 lines">GND (Shared)</td>
</tr>
<tr>
<td class="l m b0 r0 l0 t0 lines">GPIO25</td>
<td class="l m b0 r0 l0 t0 lines">Pin 22</td>
<td class="l m b0 r0 l0 t0 lines">Switch</td>
</tr>
<tr>
<td class="l m b0 r0 l0 t0 lines">GPIO13</td>
<td class="l m b0 r0 l0 t0 lines">Pin 33</td>
<td class="l m b0 r0 l0 t0 lines">LED 1</td>
</tr>
<tr>
<td class="l m b0 r0 l0 t0 lines">GPIO16</td>
<td class="l m b0 r0 l0 t0 lines">Pin 36</td>
<td class="l m b0 r0 l0 t0 lines">LED 2</td>
</tr>
<tr>
<td class="l m b0 r0 l0 t0 lines">GPIO19</td>
<td class="l m b0 r0 l0 t0 lines">Pin 35</td>
<td class="l m b0 r0 l0 t0 lines">LED 3</td>
</tr>
<tr>
<td class="l m b0 r0 l0 t0 lines">GPIO20</td>
<td class="l m b0 r0 l0 t0 lines">Pin 38</td>
<td class="l m b0 r0 l0 t0 lines">LED 4</td>
</tr>
<tr>
<td class="l m b0 r0 l0 t0 lines">GPIO26</td>
<td class="l m b0 r0 l0 t0 lines">Pin 37</td>
<td class="l m b0 r0 l0 t0 lines">LED 5</td>
</tr>
<tr>
<td class="l m b0 r0 l0 t0 lines">GPIO21</td>
<td class="l m b0 r0 l0 t0 lines">Pin 40</td>
<td class="l m b0 r0 l0 t0 lines">LED 6</td>
</tr>
</table></div></figure><p id="p-300">Using the schematics, and details provided, wire up the components to the Raspberry Pi. When done, boot it up, and proceed to the next section.</p></section><section class="subsection" id="subsection-90"><h3 class="heading hide-type">
<span class="type">Subsection</span> <span class="codenumber">9.2.5</span> <span class="title">Code</span>
</h3>
<p id="p-301">With everything wired up, transcribe the following program and run it.</p>
<p id="p-302">The majority of this code is a replication of the previous experiment. This includes some new library imports, a new class definition, and a couple of lines in the roll_dice function.</p>
<p id="p-303"><a class="external" href="https://raw.githubusercontent.com/ajbradburn/IntroToEmbeddedSystemsLabExercises/master/interfacing_bus_protocols/dice.py" target="_blank">Download the Source</a><a href="" data-knowl="" class="id-ref fn-knowl original" data-refid="hk-fn-35" id="fn-35"><sup> 35 </sup></a></p>
<figure class="listing figure-like" id="listing-38"><div class="code-box" style="width: 100%; margin-left: 0%; margin-right: 0%;"><pre class="program"><code class="language-none"> 1|  import signal
 2|  import sys
 3|  import RPi.GPIO as GPIO
 4|  from time import sleep
 5|  import random
 6|  import board
 7|  from PIL import Image, ImageDraw, ImageFont
 8|  import adafruit_ssd1306
 9|
10|  # Define a class to handle displaying a number on the LED array.
11|  class led_display:
12|    # Define LED pins. There are a number of ways to do this
13|    # I am doing it this way because I want it to be readable, and meaningful.
14|    lp1 = 13 # pin for LED 1
15|    lp2 = 16
16|    lp3 = 19
17|    lp4 = 20
18|    lp5 = 26
19|    lp6 = 21
20|    lp = [lp1, lp2, lp3, lp4, lp5, lp6] # An array of all LED pins in LED order.
21|
22|    # Class constructor function.
23|    # Initialize essential settings.
24|    def __init__(self):
25|      GPIO.setmode(GPIO.BCM)
26|      for l in self.lp:
27|        GPIO.setup(l, GPIO.OUT)
28|
29|    # Class Destructor function.
30|    # Do things that should be done with stopping.
31|    def __del__(self):
32|      GPIO.cleanup()
33|      return
34|
35|    # Display function: Illuminate n LEDs based upon a number provided.
36|    def display(self, number):
37|      if number &lt; 0:
38|        return False
39|
40|      for i in range(0, len(self.lp)):
41|        n = i + 1
42|        if n &lt;= number:
43|          GPIO.output(self.lp[i], 1)
44|        else:
45|          GPIO.output(self.lp[i], 0)
46|
</code></pre></div>
<figcaption><span class="type">Listing</span><span class="space"> </span><span class="codenumber">9.2.6<span class="period">.</span></span><span class="space"> </span></figcaption></figure><figure class="listing figure-like" id="listing-39"><div class="code-box" style="width: 100%; margin-left: 0%; margin-right: 0%;"><pre class="program"><code class="language-none">47|    # An animation to indicate something is happening.
48|    def interlude(self):
49|      # Clear all of the LEDs quickly.
50|      for l in self.lp:
51|        GPIO.output(l, 0)
52|      sleep(0.100)
53|      # Turn on each LED with a small pause between each.
54|      for l in self.lp:
55|        GPIO.output(l, 1)
56|        sleep(0.020)
57|      # Turn off each LED with a small pause between each.
58|      for l in self.lp:
59|        GPIO.output(l, 0)
60|        sleep(0.020)
61|
62|  class oled_display():
63|    # Dimensions for OLED Display.
64|    width = 128
65|    height = 32
66|    border = 0
67|
68|    i2c = None
69|    oled = None
70|
71|    def __init__(self):
72|      # Initialize the I1iC bus.
73|      self.i2c = board.I2C()
74|      self.oled = adafruit_ssd1306.SSD1306_I2C(self.width, self.height, self.i2c, addr=0x3C)
75|
76|    def display_none(self):
77|      # Reset Display/Clear
78|      self.oled.fill(0)
79|      self.oled.show()
80|
</code></pre></div>
<figcaption><span class="type">Listing</span><span class="space"> </span><span class="codenumber">9.2.7<span class="period">.</span></span><span class="space"> </span></figcaption></figure><figure class="listing figure-like" id="listing-40"><div class="code-box" style="width: 100%; margin-left: 0%; margin-right: 0%;"><pre class="program"><code class="language-none"> 81|    def display_string(self, text):
 82|      # Reset display.
 83|      self.display_none()
 84|
 85|      # Create blank image with 0-bit color.
 86|      image = Image.new("1", (self.oled.width, self.oled.height))
 87|
 88|      # Get drawing object to draw on image.
 89|      draw = ImageDraw.Draw(image)
 90|
 91|      if self.border &gt; 0:
 92|        # Draw a white background
 93|        draw.rectangle((0, 0, self.oled.width, self.oled.height), outline=255, fill=255)
 94|
 95|        # Draw a smaller inner rectangle
 96|        draw.rectangle(
 97|          (border, border, self.oled.width - self.border - 1, self.oled.height - self.border - 1),
 98|          outline=0,
 99|          fill=0,
100|          )
101|
102|      # Load default font.
103|      font = ImageFont.truetype('DejaVuSansMono.ttf', 16)
104|
105|      # Draw Some Text
106|      (font_width, font_height) = font.getsize(text)
107|      draw.text(
108|        (self.oled.width // 2 - font_width // 2, self.oled.height // 2 - font_height // 2),
109|        text,
110|        font=font,
111|        fill=10,
112|        )
113|
114|      # Display image
115|      self.oled.image(image)
116|      self.oled.show()
117|
</code></pre></div>
<figcaption><span class="type">Listing</span><span class="space"> </span><span class="codenumber">9.2.8<span class="period">.</span></span><span class="space"> </span></figcaption></figure><figure class="listing figure-like" id="listing-41"><div class="code-box" style="width: 100%; margin-left: 0%; margin-right: 0%;"><pre class="program"><code class="language-none">118|  button_pin = 25
119|
120|  # Upon Ctrl-C, exit the application
121|  def signal_handler(sig, frame):
122|    global led_display
123|    del led_display
124|    sys.exit(0)
125|
126|  def roll_dice(channel):
127|    led_display.interlude()
128|    roll = random.randint(1, 6)
129|    text = "Rolled a {}.".format(roll)
130|    oled_display.display_string(text)
131|    led_display.display(roll)
132|    print("New roll of: {}.".format(roll))
133|
134|  # Start monitoring for, and responding to, a button press.
135|  def start(button_pin, led_display, oled_display):
136|    GPIO.setup(button_pin, GPIO.IN, pull_up_down=GPIO.PUD_UP)
137|    # Monitor the button pin, and when it is pressed for 100ms, call the function roll_dice.
138|    GPIO.add_event_detect(button_pin, GPIO.FALLING, callback=roll_dice, bouncetime=100)
139|    signal.signal(signal.SIGINT, signal_handler)
140|    signal.pause()
141|
142|  led_display = led_display()
143|  oled_display = oled_display()
144|  start(button_pin, led_display, oled_display)
</code></pre></div>
<figcaption><span class="type">Listing</span><span class="space"> </span><span class="codenumber">9.2.9<span class="period">.</span></span><span class="space"> </span></figcaption></figure></section><section class="subsection" id="subsection-91"><h3 class="heading hide-type">
<span class="type">Subsection</span> <span class="codenumber">9.2.6</span> <span class="title">Exploration</span>
</h3>
<p id="p-304">Lines 6, 7, and 8 import libraries needed for interfacing with the OLED display. <code class="code-inline tex2jax_ignore">board</code> provides the <span class="process-math">\(I^2C\)</span> protocol support, <code class="code-inline tex2jax_ignore">PIL</code> provides libraries for creating images that will be sent to the OLED display, and <code class="code-inline tex2jax_ignore">adafruit_ssd1306</code> provides the handlers for sending data to the OLED display over <span class="process-math">\(I^2C\text{.}\)</span></p>
<p id="p-305">Next, we declare a class that will handle sending our roll results to the display. The main function is <code class="code-inline tex2jax_ignore">display_string</code> which will take a preformatted sentence, incorporate it into an image, and send that image to the OLED display.</p>
<p id="p-306">Classes are very important structures, if you continue on with programming, you'll explore them more. If you're interested, chapters 15 through 19 of <a class="external" href="https://open.umn.edu/opentextbooks/textbooks/think-python-how-to-think-like-a-computer-scientist" target="_blank">Think Python: How to Think Like a Computer Scientist. 2nd Edition</a><a href="" data-knowl="" class="id-ref fn-knowl original" data-refid="hk-fn-36" id="fn-36"><sup> 36 </sup></a> cover the subject matter in more detail.</p>
<p id="p-307">In the <code class="code-inline tex2jax_ignore">roll_dice</code> function we've added two lines. The first formats a string of text that includes our rolled number. The next passes that text to the <code class="code-inline tex2jax_ignore">display_string</code> function discussed previously.</p>
<p id="p-308">Finally, to interact with the OLED display, we've modified the <code class="code-inline tex2jax_ignore">start</code> function to allow an <code class="code-inline tex2jax_ignore">oled_display</code> object to be passed to it, and we've initialized a variable that points to an instance of our <code class="code-inline tex2jax_ignore">oled_display</code> class we defined earlier.</p>
<p id="p-309">With this itteration of our project, when the button is pressed, the output is displayed on the LED display as before, but also on the OLED display in plain text.</p></section></section><div class="hidden-content tex2jax_ignore" id="hk-fn-35"><div class="fn"><code class="code-inline tex2jax_ignore">https://raw.githubusercontent.com/ajbradburn/IntroToEmbeddedSystemsLabExercises/master/interfacing_bus_protocols/dice.py</code></div></div>
<div class="hidden-content tex2jax_ignore" id="hk-fn-36"><div class="fn"><code class="code-inline tex2jax_ignore">https://open.umn.edu/opentextbooks/textbooks/think-python-how-to-think-like-a-computer-scientist</code></div></div>
</div></main>
</div>
<script src="https://unpkg.com/prismjs@v1.22.0/components/prism-core.min.js"></script><script src="https://unpkg.com/prismjs@v1.22.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>
